{% unless settings.shipping_calculator == 'Disabled' %}
  <div id="shipping-calculator" style="width: 100%; max-width:400px;">
    <h3 style="font-size: 1.6rem;">{{ settings.shipping_calculator_heading | default: 'Get shipping estimates' }}</h3>
    <form id="shippingCalculator">
      <div>
        <div class="d-flex justify-content-between mt-1 mb-1">
          <label for="address_country">Country</label>
          <select
            id="address_country"
            name="address[country]"
            style="width: 100%; max-width:200px;"
          >
            {{ country_option_tags }}
          </select>
        </div>
        <div class="d-flex justify-content-between mt-1 mb-1" id="address_province_container">
          <label for="address_province" id="address_province_label">Province</label>
          <select
            id="address_province"
            name="address[province]"
            style="width: 100%; max-width:200px;"
            data-default="{% if shop.customer_accounts_enabled and customer and customer.default_address.province != '' %}{{ customer.default_address.province }}{% endif %}"
          ></select>
        </div>
        <div class="d-flex justify-content-between mt-1 mb-1">
          <label for="address_zip">Zip/Postal Code</label>
          <input
            type="text"
            id="address_zip"
            name="address[zip]"
            style="width: 100%; max-width:200px;"
            {% if shop.customer_accounts_enabled and customer %}
              value="{{ customer.default_address.zip }}"
            {% endif %}
          >
        </div>

        <p id="shipping-calculator-error" class="text-center mb-2 mt-2" style="color: red;"></p>
        <button
          type="button"
          id="calculate_shipping_btn"
          class="get-rates btn button w-100"
        >
          {{ settings.shipping_calculator_submit_button_label | default: 'Calculate shipping' }}
        </button>

        <ul id="shipping-charges-list" class="mt-3 mb-3"></ul>
      </div>
    </form>
    <div id="wrapper-response"></div>
  </div>
{% endunless %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    getProvince();
    document.getElementById('address_country').addEventListener('change', () => {
      getProvince();
    });

    document.getElementById('calculate_shipping_btn').addEventListener('click', (e) => {
      getShippingRates(e);
    });
  });

  function getProvince() {
    let val = document.getElementById('address_country');
    let province = JSON.parse(val.options[val.selectedIndex].dataset.provinces);
    let options = '';
    province.forEach((arr) => {
      options = options + `<option value="${arr[0]}">${arr[0]}</option>`;
    });
    document.getElementById('address_province').innerHTML = options;
  }

  async function getShippingRates(e) {
    let country = document.getElementById('address_country').value;
    let state = document.getElementById('address_province').value;
    let zipCodee = document.getElementById('address_zip').value;
    let errorMsgElement = document.getElementById('shipping-calculator-error');
    let shippingList = document.getElementById('shipping-charges-list');

    await fetch(
      '/cart' +
        '/shipping_rates.json?shipping_address[zip]=' +
        zipCodee +
        '&shipping_address[country]=' +
        country +
        '&shipping_address[province]=' +
        state,
      {
        credentials: 'same-origin',
        method: 'GET',
      }
    )
      .then((res) => res.json())
      .then((res) => {
        console.log('res', res);
        if (res.zip && res.zip.length > 0) {
          errorMsgElement.innerHTML = res.zip[0];
          shippingList.innerHTML = '';
        } else {
          errorMsgElement.innerHTML = '';
          let rateList = '';
          res.shipping_rates.forEach((rate) => {
            rateList += `<li class="d-flex justify-content-between">
              <span>${rate.presentment_name} (${rate.delivery_days[0]}-${rate.delivery_days[1]} days)</span>
              <span>$${rate.price}</span>
              </li>`;
          });
          shippingList.innerHTML = rateList;
        }
      })
      .catch(function (error) {
        console.log('error:', error);
      });
  }
</script>
